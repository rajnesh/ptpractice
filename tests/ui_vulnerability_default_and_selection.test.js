/**
 * @jest-environment jsdom
 */

const fs = require('fs');
const path = require('path');
const vm = require('vm');

function bootAppWithDOM(html, engineStub) {
  document.body.innerHTML = html;
  // Provide engine stub
  global.window.SAYCBiddingSystem = engineStub || class {
    constructor() { this.currentAuction = null; }
    startAuction(ourSeat, weVul, theyVul) {
      this.weVul = weVul; this.theyVul = theyVul;
      this.currentAuction = { bids: [], reseat: () => {} };
    }
    getBid() { return { token: 'PASS', conventionUsed: 'Pass' }; }
  };
  // Minimal types used by app in jsdom smoke
  global.window.Hand = class { constructor() { this.lengths = { S:4,H:3,D:3,C:3 }; this.suitBuckets = { S:[],H:[],D:[],C:[] }; this.hcp = 10; this.toString = ()=>'TEST'; } };
  global.window.Bid = class { constructor(tok){ this.token = tok || 'PASS'; } };
  // Load app.js in VM context bound to window and document
  const appPath = path.resolve(__dirname, '../assets/js/app.js');
  const code = fs.readFileSync(appPath, 'utf8');
  const context = vm.createContext({ window: global.window, self: global.window, global: global.window, document: global.document, console, setTimeout, clearTimeout });
  vm.runInContext(code, context, { filename: 'app.js' });
  return context;
}

describe('Vulnerability defaults and selection handling', () => {
  test('defaults vulnerability to None when unset and updates overlay', () => {
    let captured = { we:null, they:null };
    class EngineStub { constructor(){ this.currentAuction=null; } startAuction(ourSeat,weVul,theyVul){ captured.we=weVul; captured.they=theyVul; this.currentAuction={ bids:[], reseat:()=>{} }; } getBid(){ return { token:'PASS', conventionUsed:'Pass' }; } }
    const ctx = bootAppWithDOM(`
      <div id="gameLayout" style="display:none"></div>
      <div id="dealerBadge"></div>
      <div id="vulnBadge"></div>
      <select id="dealer"><option value="S">S</option></select>
      <select id="vulnerability"></select>
      <div id="auctionSetup"></div>
      <div id="conventionCheckboxes"></div>
      <div class="auction-grid">
        <div class="auction-position"></div>
        <div class="auction-position"></div>
        <div class="auction-position"></div>
        <div class="auction-position"></div>
      </div>
      <div id="auctionBids"></div>
      <div id="auctionStatus"></div>
      <div id="startAuctionBtn"></div>
      <div id="generalSettings"></div>
      <div id="northHand"></div><div id="eastHand"></div><div id="southHand"></div><div id="westHand"></div>
      <div id="northHandContent"></div><div id="eastHandContent"></div><div id="southHandContent"></div><div id="westHandContent"></div>
      <div class="hands-grid"></div>
      <button id="toggleHandsBtn"></button>
      <div id="handValidationError"></div>
  `, EngineStub);

    expect(typeof ctx.initializeSystem).toBe('function');
    ctx.initializeSystem();

    // The overlay should reflect None regardless of select options
    const badge = document.getElementById('vulnBadge');
    expect(badge.textContent).toMatch(/Vul:\s*None/i);

    // Starting an auction should pass false/false to the engine
  ctx.processTurn = () => {}; 
    ctx.startNewAuction();
    expect(captured.we).toBe(false);
    expect(captured.they).toBe(false);
  });

  test('respects user-selected vulnerability and passes to engine on start', () => {
    let captured = { we: null, they: null };
    class EngineStub {
      constructor(){ this.currentAuction = null; }
      startAuction(ourSeat, weVul, theyVul){ captured.we = weVul; captured.they = theyVul; this.currentAuction = { bids: [], reseat: () => {} }; }
      getBid(){ return { token:'PASS', conventionUsed:'Pass' }; }
    }

    const ctx = bootAppWithDOM(`
      <div id="gameLayout" style="display:none"></div>
      <div id="dealerBadge"></div>
      <div id="vulnBadge"></div>
      <select id="dealer"><option value="S">S</option></select>
      <select id="vulnerability"><option value="ns">ns</option><option value="both">both</option></select>
      <div id="auctionSetup"></div>
      <div id="conventionCheckboxes"></div>
      <div class="auction-grid">
        <div class="auction-position"></div>
        <div class="auction-position"></div>
        <div class="auction-position"></div>
        <div class="auction-position"></div>
      </div>
      <div id="auctionBids"></div>
      <div id="auctionStatus"></div>
      <div id="startAuctionBtn"></div>
      <div id="generalSettings"></div>
      <div id="northHand"></div><div id="eastHand"></div><div id="southHand"></div><div id="westHand"></div>
      <div id="northHandContent"></div><div id="eastHandContent"></div><div id="southHandContent"></div><div id="westHandContent"></div>
      <div class="hands-grid"></div>
      <button id="toggleHandsBtn"></button>
      <div id="handValidationError"></div>
    `, EngineStub);

    ctx.initializeSystem();

    // Change the UI dropdown to 'both' and trigger change
    const vulnSel = document.getElementById('vulnerability');
    vulnSel.value = 'both';
    vulnSel.dispatchEvent(new Event('change'));

      const badge = document.getElementById('vulnBadge');
      expect(badge.textContent).toMatch(/Vul:\s*Both/i);

    // Avoid heavy UI flows during startNewAuction
    ctx.processTurn = () => {};

    // Start the auction and verify engine received vulnerability flags
    ctx.startNewAuction();
    expect(captured.we).toBe(true);
    expect(captured.they).toBe(true);
  });
});
